name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-test:
    name: ${{ matrix.os }} / ${{ matrix.preset }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        preset: [ci-release, ci-debug]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          # Choose what you want to support. If you really need 3.14 and it's available, set it here.
          # Otherwise, 3.12 is a safe default today.
          python-version: "3.12"

      # Make CMakePresets.json inheritance work:
      # your presets expect ${env:pythonLocation}
      - name: Export pythonLocation for presets
        shell: bash
        run: |
          echo "pythonLocation=${pythonLocation}" >> $GITHUB_ENV

      - name: Configure (CMake preset)
        run: cmake --preset ${{ matrix.preset }}

      - name: Build (CMake preset)
        run: cmake --build --preset ci-build-${{ contains(matrix.preset, 'release') && 'release' || 'debug' }}

      - name: Test (CTest preset)
        run: ctest --preset ci-test-${{ contains(matrix.preset, 'release') && 'release' || 'debug' }}